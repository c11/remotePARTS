---
title: "Alaska"
subtitle: "NDVI analysis {remotePARTS}"
author: "Clay Morrow"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Alaska}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r chunk_setup, include = FALSE}
library(knitr)
knitr::opts_chunk$set(collapse = TRUE, comment = "##", dpi = 150)
```


# Introduction 

This vignette will demonstrate the main functionality of `remotePARTS` by working
through a real remote sensing dataset. 

```{r public_library}
library(remotePARTS)
```

```{r private_library, echo = FALSE}
library(dplyr)
library(ggplot2)
```

# Alaska datasets

`remotePARTS` ships with two data sets. Both sets contain NDVI values, derived 
from NASA's MODIS for the US State of Alaska. The first set, `ndvi_AK`, contains 
all 3,1486 pixels and `ndvi_AK3000` is a representative subset of 3000 of those
pixels. `ndvi_AK3000` exists as a smaller data set that can be processed much 
faster than `ndvi_AK` but both sets contain all the same variables and can be 
analyzed similarly. These data can be loaded with `data("ndvi_AK")` and 
`data("ndvi_AK3000")`.

```{r}
data("ndvi_AK")
```

`ndvi_AK` is a `data.frame` with 38 columns. `lng` and `lat` are longitude and
latitude, respectively. `AR_coef` and `CLS_coef` are pre-calculated coefficient
estimates from pixel-level time series analyses via AR REML and conditional least
squares, respectively. `land` is a factor representing land cover classes and 
`rare.land` is a logical filtering variable that indicates if a pixel's land cover
class occurs in less than 2% of the map. The remaining 32 columns, of the form 
`ndviYYYY` contain the NDVI values from 1982 to 2013.

```{r}
str(ndvi_AK)
```

Both `ndvi_AK` and `ndvi_AK3000` have no missing data. `remotePARTS` can **not**
handle any missing data. It is essential that **all** missing data is removed 
prior to conducting any analyses. 

We are interested in asking these question of these data, "Is NDVI in Alaska 
increasing over time?" and "Are Alaska's NDVI trends associated with land cover
classes?", and "Do Alaska's NDVI trends differ with latitude?"

The below figure shows a temporal cross-section of these data: 1982, 1998, and 2013. 

```{r, fig.width = 7.5, fig.asp = .4, echo = FALSE}
reshape2::melt(ndvi_AK, measure = c("ndvi1982", "ndvi1998", "ndvi2013")) %>% 
  ggplot(aes(x = lng, y = lat, col = value )) + 
  geom_tile() +
  labs(col = "ndvi") +
  facet_wrap(~ gsub("ndvi", "", variable), ncol = 3) +
  scale_color_viridis_c(option = "magma") +
  # scale_color_gradient2(low = "darkorchid", high = "forestgreen", mid = "grey", midpoint = 10) + 
  labs(x = "Longitude", y = "Latitude") +
  theme(panel.grid = element_blank(), strip.background = element_blank(),
        panel.background = element_blank()) 
```

And this figure shows how Alaska's three primary land cover classes are distributed:

```{r fig.width = 4, fig.asp = .9, echo = FALSE}
ndvi_AK %>% filter(rare.land == FALSE) %>% 
ggplot(aes(x = lng, y = lat, fill = land, col = land)) + 
  geom_tile() + 
  scale_fill_viridis_d(direction = -1, end = .9) + 
  scale_color_viridis_d(direction = -1, end = .9) +
  labs(y = "Latitude", x = "Longitude", col = "Land cover", fill = "Land cover") +
  theme(panel.grid = element_blank(), strip.background = element_blank(),
        panel.background = element_blank()) 
```

# Time series analysis

The first step in a typical `remotePARTS` workflow is to obtain pixel-level trend
estimates. In this case, we are interested in estimating the time trends in NDVI
for each pixel, represented by $\beta_1$ from the regression model

$$ y(t) = \beta_0 + \beta_1 t + \varepsilon(t)$$

where the innovations $\varepsilon(t)$ follow an AR(1) process: 
$\varepsilon(t) = b\varepsilon(t - 1) + \delta(t)$; and random normal 
$\delta(t) \sim N(0 , \sigma)$

We will use `fitAR_map()` to estimate $\beta_1$, which fits pixel-level AR(1) 
models to a map of pixels and estimates parameters using restricted maximum 
likelihood (REML). 

To do so, we must extract only our NDVI columns as the matrix `Y`. We'll do this
by matching all column names containing "ndvi" and slicing the data frame:

```{r}
ndvi.cols = grep("ndvi", names(ndvi_AK3000), value = TRUE)
Y = as.matrix(ndvi_AK3000[, ndvi.cols])
```

We also need a 2-column coordinate matrix `coords`:

```{r}
coords = as.matrix(ndvi_AK3000[, c("lng", "lat")])
```

`Y` and `coords` are then passed `fitAR_map()` with default settings:

```{r}
ARfit = fitAR_map(Y = Y, coords = coords)
```

Coefficient estimates can be obtained from `ARfit` with `coefficients()`. The 
first column is $\hat{\beta_0}$ and the second is $\hat{\beta_1}$.

```{r}
head(coefficients(ARfit))
```

Below is an image of the estimated coefficients for the full `ndvi_AK`. From this,
we can see that the general pattern is for northern latitudes to be greening 
faster (slightly) than more southern latitudes.

```{r fig.width = 4, fig.asp = .9, echo = FALSE}
ndvi_AK %>% filter(rare.land == FALSE) %>% 
ggplot(aes(x = lng, y = lat, fill = AR_coef, col = AR_coef)) + 
  geom_tile() + 
  scale_color_gradient2(high = "forestgreen", low = "darkorchid", mid = "grey90", midpoint = 0) +
  guides(fill = "none") + 
  labs(y = "Latitude", x = "Longitude", col = expression(beta[1]), fill = expression(beta[1])) +
  theme(panel.grid = element_blank(), strip.background = element_blank(),
        panel.background = element_blank()) 
```
